# Noise Protocol: Decrypting Messages

Boom, Bob received the `init` message from Alice, encrypted and safe from eavesdroppers!

Let's see how Bob goes about decrypting the message, using the cryptographic material he derived during the handshake phase.

<p align="left" style="width: 50%; max-width: 300px;">
  <img src="./tutorial_images/decrypting_messages.png" alt="decrypting_messages" width="100%" height="auto">
</p>

### Step 1: Bob Reads 18 Bytes from Network Buffer

Bob will begin by reading exactly 18 bytes from the network buffer. Why *exactly* 18? Because we know the encrypted length prefix is 2 bytes, and its corresponding authentication tag MAC is 16 bytes.

### Step 2: Decrypt the Length Prefix and Verify MAC

Next, Bob will use ChaCha20-Poly1305 AEAD decryption to decrypt the cipher and retrieve the plaintext length.

To decrypt the length, Bob will use the following:
- **rk**: Bob's **Receiving Key** which was derived during the Noise handshake.
- **nonce**: Bob's **Receiving Nonce**, which is set to 0 for the first use.
- **ad**: Associated data, which is empty in Lightning's message encryption.
- **ciphertext**: The 2-byte ciphertext `lc`.
- **MAC**: The cipher's corresponding authentication tag MAC.

The ChaCha20-Poly1305 algorithm will verify the MAC during decryption. If it doesn't match what is expected, the function will fail and Bob must immediately abort the connection.

### Step 3: Read `l` + 16 Bytes from Network Buffer

Assuming the length cipher nicely decrypts, Bob is now equiped with the message length (`l`) that he needs to read from the network buffer.

He will then proceed to read the next `l + 16` bytes, where the first `l` bytes are the encrypted message and the next 16 bytes is the MAC.

### Step 4: Decrypt the Message and Verify MAC

Finally, Bob will decrypt the message payload using ChaCha20-Poly1305 again. However, this time, he will increment the nonce value first, matching the nonce that Alice used to encrypt the message. He will also pass in the authentication tag MAC associated with the ciphertext.

Just like in Step 2, the MAC is verified during decryption. If verification fails, Bob aborts the connection immedieately.

### Step 5: Increment Nonce

Bob will finalize the decryption process by incrementing his **Receiving Nonce** by 1, ensuring he is ready to decrypt the next message he receives from Alice. 