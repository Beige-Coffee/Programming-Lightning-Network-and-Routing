# Noise Protocol: Key Rotation

Let's imagine Alice and Bob open a Lightning channel that becomes well-connected in the network. They've found the secret sauce that makes for a profitable Lightning node!

As their channel routes many payments, Alice and Bob will send numerous messages back and forth to coordinate these operations.

<p align="left" style="width: 50%; max-width: 300px;">
  <img src="./tutorial_images/alice_bob_communication.png" alt="alice_bob_communication" width="100%" height="auto">
</p>

#### Question: Let's make sure you were paying attention! What happens if Alice and Bob never change their encryption keys?

<details>
  <summary>Answer</summary>

If Alice and Bob never *change - sometimes called "rotate" - their keys* during the course of their communication, they have no **forward secrecy**. Forward secrecy means that, if a key is ever compromised **today**, those keys cannot be used to decrypt messages from the **past**.

In the context of Lightning, it should be clear why this would be pretty bad. All of the network communication and payment traffic would be visible by the attacker! 

To prevent this, [BOLT 8](https://github.com/lightning/bolts/blob/master/08-transport.md#lightning-message-key-rotation) describes a mechanism for rotating keys every 1,000 uses (i.e. 500 messages). This ensures that any key leakage is limited to a smaller window of exposure.

It's worth noting that Lightning doesn't use the Noise Protocol's built-in `Rekey()` function. Instead, Lightning defines its own key rotation mechanism in BOLT 8, which uses HKDF, resets the nonce counter, and mandates rotation every 1,000 encryptions.

</details>

Now that we've developed an intuition for why Alice and Bob need to rotate their keys, let's see how it's done.


<p align="left" style="width: 50%; max-width: 300px;">
  <img src="./tutorial_images/key_rotation.png" alt="key_rotation" width="100%" height="auto">
</p>

### Step 1: Alice Gets the Chaining Key from Act Three (or the Last Rotation)

First, Alice will get the **Chaining Key** that we last saw in Act Three. If you recall, Alice created the Chaining Key by accumulating (or "chaining") all of the ECDH outputs throughout the handshake process, thereby linking the Chaining Key to all of the steps that were take to establish the connection with Bob. By continueing to use the Chaining Key to derive fresh encryption and decryption keys, Alice continues to contribute accumulated entropy, providing a strong foundation for deriving keys.

<details>
  <summary>Click here for a reminder of the steps Alice performed in Act 3</summary>
  
<p align="left" style="width: 50%; max-width: 300px;">
  <img src="./tutorial_images/noise_act3_alice.png" alt="noise_act3_alice" width="100%" height="auto">
</p>
  
</details>

### Step 2: Alice Derives a New Key and New Chaining Key

Once Alice is equpred with the Chaining Key, she will input the key in the HMAC-based Key Derivation Function (HKDF) to derive both a new encryption key and Chaining Key for the next 1,000 nonces.

Remember how Alice derived two different keys? Once for sending messages (`sk`) and one for receiving messages (`rn`)? Well, depending on which key has reached the nonce counter of 1,000, that is the key that Alice will input into the HKDF function to rotate. In the visual above, Alice is depicted as rotating her **Sending Key** (`sk`).

The output of the function is `ck'` (the new chaining key) and `sk'` (the new sending key).

### Step 3: Alice Resets the Nonce and Uses New Key for Communication

Finally, Alice will reset the nonce for the associated key that was just rotated. In this case, Alice resets her sending nonce (`sn`) to `0`, giving her a fresh nonce space for the next 500 Lightning messages.