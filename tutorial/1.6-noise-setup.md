# Noise Protocol: Handshake Setup

Before Alice and Bob can begin the handshake process, they will each initialize a **session state**. This will serve two important purposes during the handshake phase:
1) **Noise Variant Validation**: As part of the setup, Alice and Bob will each initialize their session state as as a hash of Lightning's Noise Protocol name `Noise_XK_secp256k1_ChaChaPoly_SHA256`), the ASCII string `lightning`, and the *responder's* (Bob's) static public key. Since Alice and Bob will both compute this independently, if they're using different Noise variants or if Alice doesn't know Bob's correct public key, their session states will diverge and the rest of the handshake process will fail. By calculating this session state during the setup, we ensure that Alice and Bob are using the exact same Noise variant and that Alice knows Bob's true public key.
2) **Initialize Handshake Hash and Chaining Key**:
- **Handshake Hash**: As we briefly reviewed in the last section, Alice and Bob will only transmit their ephemeral public keys and Alice's encrypted static key as messages to each other. But how do they ensure the messages are not being tampered with while in transit? To do this, Alice and Bob each use the handshake hash as a running *transcript*. During each act of the handshake process, Alice and Bob independently mix new data into their handshake hash and use the updated handshake hash as associated data when creating their message authentication codes (MACs). By including the handshake hash in each MAC, Alice and Bob can verify that they are in sync and that the messages originated from each other and were not tampered with.
- **Chaining Key**: The Chaining Key plays a similar role. Throughout the handshake phase, Alice and Bob accumulate each ECDH output into the Chaining Key, which serves as the source of entropy for deriving all encryption and decryption keys, providing both secure communication and forward secrecy.


<p align="left" style="width: 50%; max-width: 300px;">
  <img src="./tutorial_images/noise_setup.png" alt="noise_setup" width="100%" height="auto">
</p>


### Step 1: Create 32-byte Hash to Identify Noise Variant
The first step to get set up for the Noise Handshake is to create a SHA256 hash of Noise variant. This ensures that Alice and Bob can both authenticate that they are using the exact same handshake protocol and cryptographic primitives.
<p align="left" style="width: 50%; max-width: 300px;">
  <img src="./tutorial_images/noise_setup1.png" alt="noise_setup1" width="100%" height="auto">
</p>

### Step 2: Define "Chaining Key"
Next, Alice and Bob will initiate the **Chaining Key** by setting it equal to a copy of the **hash** from Step 1. As we learned earlier, the **Handshake Hash** will serve as a "transcript" or accumulator used to mix in data as both parties progress through the handshake. Before Alice or Bob send a message to each other, they will use the hash as Associated Data for the Message Authentication Code (MAC), allowing both Alice and Bob to verify that they are progressing through the handshake acts in sync.

The **Chaining Key** will be used as an input into the Hash-based Key Derivation Function (HKDF) to derive new symmetric encryption keys needed during the handshake process.

<p align="left" style="width: 50%; max-width: 300px;">
  <img src="./tutorial_images/noise_setup2.png" alt="noise_setup2" width="100%" height="auto">
</p>

### Step 3: Bind Handshake to Lightning
Now, Alice and Bob will mix in the **prologue** to their hash. In Noise, a ["prologue"](https://en.wikipedia.org/wiki/Noise_Protocol_Framework#Prologue_%C2%A76) is arbitrary data that gets mixed into the initial handshake hash. This specifies the exact context in which this Noise protocol is meant to be used - the Lightning Network!
<p align="left" style="width: 50%; max-width: 300px;">
  <img src="./tutorial_images/noise_setup3.png" alt="noise_setup3" width="80%" height="auto">
</p>

### Step 4: Mix in Responder's Static Public Key
Finally, Alice and Bob will mix Bob, the responder's, public key into the hash. This is because, per the `XK` Noise handshake variant, the responder's static key is known ahead of time, so mixing it into the hash ensures this is true before the main handshake process starts. It also stops Alice from accidentally connecting to the wrong node. Whoops!
<p align="left" style="width: 50%; max-width: 300px;">
  <img src="./tutorial_images/noise_setup4.png" alt="noise_setup4" width="40%" height="auto">
</p>