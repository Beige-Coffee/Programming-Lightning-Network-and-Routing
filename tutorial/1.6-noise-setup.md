# Noise Protocol: Handshake Setup

Before Alice and Bob can begin the handshake process, they will each initialize a **session state**. This will serve two important purposes during the handshake phase:
1) **Noise Variant Validation**: The beginning session state starts as a hash of Lightning's Noise Protocol name `Noise_XK_secp256k1_ChaChaPoly_SHA256`), the ASCII string `lightning`, and the *responder's* (Bob's) static public key. Since Alice and Bob will both compute this independently, if they're using different Noise variants or if Alice doesn't know Bob's correct public key, their session states will diverge and subsequent message decryption will fail. By calculating this session state during the setup, we ensure that Alice and Bob are using the exact same Noise variant and that Alice knows Bob's true public key.
2) **Maintain Synchronization**: If Alice and Bob both produce the same hash for the session state, then they know they are using the same Noise Protocol and are in sync. As they work their way through the rest of the handshake process, they will continue to mix data into the hash after each "act." This hash is used as associated data in encryption, so if they fall out of sync at any point, decryption will fail, keeping them synchronized throughout the entire handshake phase.
Now, let's see how things are done!

### Step 1: Create 32-byte Hash to Identify Noise Variant
The first step to get set up for the Noise Handshake is to create a SHA256 hash of Noise variant. This ensures that Alice and Bob can both authenticate that they are using the exact same handshake protocol and cryptographic primitives.
<p align="left" style="width: 50%; max-width: 300px;">
  <img src="./tutorial_images/noise_setup1.png" alt="noise_setup1" width="100%" height="auto">
</p>

### Step 2: Define "Chaining Key"
Next, Alice and Bob will initiate the **Chaining Key** by setting it equal to a copy of the **hash** from Step 1. From here on out, these values will serve two purposes:
- **Hash**: The hash will serve as an **accumulator**. As Alice and Bob progress through each act in the handshake, they will continue to mix new data into their respective hashes. The hash data will be provided as Associated Data for the Message Authentication Code (MAC), allowing both Alice and Bob to verify that they are progressing through the handshake acts in sync. This will become more clear as we review the handshake acts.
- **Chaining Key**: The chaining key will be used as an input into the Hash-based Key Derivation Function (HKDF) to derive new symmetric encryption keys needed during the handshake process.
<p align="left" style="width: 50%; max-width: 300px;">
  <img src="./tutorial_images/noise_setup2.png" alt="noise_setup2" width="100%" height="auto">
</p>

### Step 3: Bind Handshake to Lightning
Now, Alice and Bob will mix in the **prologue** to their hash. In Noise, a ["prologue"](https://en.wikipedia.org/wiki/Noise_Protocol_Framework#Prologue_%C2%A76) is arbitrary data that gets mixed into the initial handshake hash. This specifies the exact context in which this Noise protocol is meant to be used - the Lightning Network!
<p align="left" style="width: 50%; max-width: 300px;">
  <img src="./tutorial_images/noise_setup3.png" alt="noise_setup3" width="80%" height="auto">
</p>

### Step 4: Mix in Responder's Static Public Key
Finally, Alice and Bob will mix Bob, the responder's, public key into the hash. This is because, per the `XK` Noise handshake variant, the responder's static key is known ahead of time, so mixing it into the hash ensures this is true before the main handshake process starts.
<p align="left" style="width: 50%; max-width: 300px;">
  <img src="./tutorial_images/noise_setup4.png" alt="noise_setup4" width="40%" height="auto">
</p>