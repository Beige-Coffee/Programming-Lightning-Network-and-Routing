# The Lightning Network

If you joined us for the first module in Programming Lightning, Intro to Payment Channels, you'll likely remember that we ended by reviewing an example where Alice sent Dianne a Hash-Time-Locked-Contract (HTLC) *through* Bob. In that course, we paid special attention to the HTLC script, as well as the BOLT 2 protocol messages that are exchanged during the process of initiating and settling the HTLC. This is also visualized in the diagram below.

In this course, we'll be diving deeper into this payment example, but, instead of focusing on HTLCs, we'll explore the following questions:
1) How does Alice create an authenticated connection with Bob or anyone else on the Lightning Network?
2) How is Alice able to privately and securely route payment information to peers?
3) What information do nodes broadcast to each other to facilitate sending payments on the Lightning Network?

<p align="center" style="width: 50%; max-width: 300px;">
  <img src="./tutorial_images/alice_bob_graph.png" alt="alice_bob_graph" width="100%" height="auto">
</p>

## The Purpose Of The Lightning Network
From a philosophical perspective, the purpose of the Lightning Network is to help bitcoin realize the vision of peer-to-peer electronic cash. However, from a simpler, more computer science perspective, the purpose of the Lightning Network is to transfer data securely between peers.

todo?

# The Networking Stack

Before we start answering any of the above questions and getting into fun cryptography and protocol messages, it's helpful if we begin with an even more primitive concept - the networking stack. In other words, **how do Lightning nodes identify and communicate with each other securely**?

In the diagram below, you'll see a simplified visual of the networking stack that Lightning uses. The bottom two layers, IP and TCP, are standard internet protocols that are not specific to Lightning. On the other hand, the top two layers - Lightning's application layer and the Noise Protocol security layer - are what make Lightning unique. We'll spend the majority of this course focusing on the top two layers, but we'll start with a brief overview of the bottom layers, as this will help provide context and set a solid foundation for the rest of the content.

<p align="center" style="width: 50%; max-width: 300px;">
  <img src="./tutorial_images/networking_stack.png" alt="networking_stack" width="100%" height="auto">
</p>

## Internet Protocol

To connect to peers on the Lightning Network, nodes will need to establish connections and send data to their peers over the internet. This is similar to addressing a letter or email - you must specify *where* to send the letter. Otherwise, the letter will be forever lost in (cyber)space, lonely and looking for its purpose in life. Furthermore, this process requires standardization to run smoothly. For instance, if there wasn't a universally accepted language or protocol to define how to format internet locations, it would be near impossible to reliably send data.

The **Internet Protocol** standardizes internet communications by providing a set of rules for *routing* and *addressing* packets of data. Using this protocol, internet-connected devices can easily identify other devices in cyberspace and send each other packets of data.

To explore this concept further, let's zoom into Alice's connection with Bob. As you can see in the visual below, Alice and Bob's Lightning nodes both use the Internet Protocol to obtain Internet Protocol (IP) addresses, which specify where their **host** (Lightning node) is running in cyberspace.

<p align="center" style="width: 50%; max-width: 300px;">
  <img src="./tutorial_images/alice_bob_ip.png" alt="alice_bob_ip" width="100%" height="auto">
</p>

## TCP (Transmission Control Protocol)

While the Internet Protocol defines a standard for how to identify devices on the internet (IP Address) and how to route IP packets from a source to destination, it lacks many of the advanced features that are required for a modern protocol. Therefore, it is combined with a **Transport Layer** protocol such as **Transmission Control Protocol** or **User Datagram Protocol**.

Transmission Control Protocol is a transport protocol that brings additional features to routing IP packets such as:
- IP packets arrive in order
- The recipient acknowledges that packets have arrived
- Missing packets will be sent again if not acknowledged
- Port numbers identify which application receives the data

These features are actually ***required*** for Lightning. For example, consider this sentence from [BOLT #1](https://github.com/lightning/bolts/blob/master/01-messaging.md), which describes Lightning's Base Protocol: **This protocol assumes an underlying authenticated and ordered transport mechanism that takes care of framing individual messages**.

#### Question: Why is ordered transport required by Lightning?

> HINT: Think of BOLT 2 and how we send protocol messages to advance channel state!

<details>
  <summary>Answer</summary>

First, let's review what "ordered transport" is.

**Ordered transport**, unsurprisingly, means that messages will arrive in the same order that they were sent. To see why this is critical, let's take a brief field trip to [BOLT #2: Peer Protocol for Channel Management](https://github.com/lightning/bolts/blob/master/02-peer-protocol.md). BOLT #2 describes the message types that peers will send each other to update their channel states. For instance, below are two common message types:

<p align="center" style="width: 50%; max-width: 300px;">
  <img src="./tutorial_images/alice_bob_tcp_0.png" alt="alice_bob_tcp_0" width="50%" height="auto">
</p>

- `update_add_htlc`: Node A will send this message to node B (or vice versa) to indicate that they would like to add an HTLC to their counterparty's commitment transaction.
- `commitment_signed`: Node A will send this message to node B (or vice versa) to provide the signatures for the current commitment transaction, effectively advancing channel state.

Let's imagine that Alice wants to add two HTLCs to her channel with Bob. She can do that by sending two `update_add_htlc` messages to Bob and then sending a `commitment_signed` message with the appropriate signatures.

<p align="center" style="width: 50%; max-width: 300px;">
  <img src="./tutorial_images/alice_bob_tcp_1.png" alt="alice_bob_tcp_1" width="70%" height="auto">
</p>

Notice that the `commitment_signed` does not explicitly mention which HTLCs the signatures are for. Instead, it does this implicitly. Since Lightning messages are assumed to be ordered and reliable, the protocol assumes that messages sent will always arrive, and they will arrive in the order they are sent. This way, Alice can rest assured that, if Bob gets the `commitment_signed`, he also got the `update_add_htlc` messages in the correct order.

</details>

Another important feature included in TCP is a **port number**, which is a unique identifier that ensures that data is transmitted to the correct application on the receiver's machine. For instance, in the visual below, you'll see that, in addition to specifying the IP address, Alice and Bob will list their port number, which identifies the location where the Lightning Network software is running on their host machine.

<p align="center" style="width: 50%; max-width: 300px;">
  <img src="./tutorial_images/alice_bob_tcp_ip.png" alt="alice_bob_tcp_ip" width="100%" height="auto">
</p>

#### Question: Why are Alice and Bob both running Lightning on port 9735?

> HINT: If you don't know the answer, you can find it in [BOLT #1](https://github.com/lightning/bolts/blob/master/01-messaging.md)!

<details>
  <summary>Answer</summary>

According to [BOLT #1: Base Protocol](https://github.com/lightning/bolts/blob/master/01-messaging.md), 9735 is the default TCP port for mainnet Lightning nodes. The other default ports are listed below:
- **Testnet**: 19735
- **Signet**: 39735

By specifying a default port, it reduces friction for both Lightning users, developers, and educators, as everyone can create shared software and documentation that assumes a port number. That said, your Lightning node is free to run on a different port - it does not have to be 9735.

</details>

## Brief Review

An in-depth review of the Transmission Control Protocol/Internet Protocol is outside of the scope of this course. However, what is important to understand is what tools these protocols provide, and why they are crucial for Lightning Network development. As a brief review, these are the key features each layer provides:

**Internet Protocol (IP):**
- Provides unique IP addresses for every device on the internet (e.g., 198.51.100.89)
- Routes packets from source to destination across networks
- Best-effort delivery (packets may be lost, duplicated, or arrive out of order)

**Transmission Control Protocol (TCP):**
- Ensures reliable delivery through acknowledgments and retransmissions
- Guarantees ordered delivery (messages arrive in the sequence they were sent)
- Provides port numbers to route data to specific applications (e.g., port 9735 for Lightning)

Now that we understand this foundation, we can explore the Lightning-specific layers that provide security and enable the Lightning protocol itself.

## Bonus Question!

For those of you with a networking background, here is an interesting thought experiment / bonus question.

#### Question: Can we replace TCP with UDP in the Lightning Protocol? 

<details>
  <summary>Answer</summary>

#### Todo!

</details>