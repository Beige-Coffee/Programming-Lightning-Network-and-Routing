# The Lightning Network

If you joined us for the first module in Programming Lightning, Intro to Payment Channels, you'll likely remember that we ended by reviewing an example where Alice sent Dianne a Hash-Time-Locked-Contract (HTLC) *through* Bob. In that course, we paid special attention to the HTLC script, as well as the BOLT 2 protocol messages that are exchanged during the process of initiating and settling the HTLC. This is also visualized in the diagram below.

In this course, we'll be diving deeper into this payment example, but, instead of focusing on HTLCs, we'll explore the following questions:
1) How does Alice create an authenticated connection with Bob or anyone else on the Lightning Network?
2) How is Alice able to privately and securely route payment information to peers?
3) What information do nodes broadcast to each other to faciliate sending payments on the Lightning Network?

<p align="center" style="width: 50%; max-width: 300px;">
  <img src="./tutorial_images/alice_bob_graph.png" alt="alice_bob_graph" width="100%" height="auto">
</p>

# Setting the Stage

Before we start answering any of the above questions and getting into fun cryptography and protocol messages, let's ask an even more primitive question to help set the scene: **How will Lightning nodes communicate with each other**?

To conenct to peers on the Lightning Network, nodes will establish connections with each other using the Transmission Control Protocol/Internet Protocol (TCP/IP) or The Tor, which is built on TCP. 

## TCP (Transmission Control Protocol)

To connect to peers, Lightning nodes rely on TCP. This includes protocols such as IPv4, IPv6, and Tor. These protocols are used because they satisfy properties that Lightning requires. For example, consider this sentence from [BOLT #1](https://github.com/lightning/bolts/blob/master/01-messaging.md), which describes Lightning's Base Protocol: **This protocol assumes an underlying authenticated and ordered transport mechanism that takes care of framing individual messages**.

#### Question: Why is ordered transport required by Lightning?

> HINT: Think of BOLT 2 and how we send protocol messages to advance channel state!


<details>
  <summary>Answer</summary>

First, let's review what "ordered transport" is.

**Ordered transport**, unsurprisingly, means that messages will arrive in the same order that they were sent. To see why this is critical, let's take a brief field trip to [BOLT #2: Peer Protocol for Channel Management
](https://github.com/lightning/bolts/blob/master/02-peer-protocol.md). BOLT #2 describes the message types that peers will send eachother to update their channel states. For instance, below are two common message types:

<p align="center" style="width: 50%; max-width: 300px;">
  <img src="./tutorial_images/alice_bob_tcp_0.png" alt="alice_bob_tcp_0" width="50%" height="auto">
</p>

- `update_add_htlc`: Node A will send this message to node B (or vice versa) to indicate that they would like to add an HTLC to their counterparty's commitment transaction.
- `commitment_signed`: Node A will send this message to node B (or vice versa) to provide the signatures for the current commitment transaction, effectively advancing channel state.

Let's imagine that Alice wants to add two HTLCs to her channel with Bob. She can do that by sending two `update_add_htlc` messages to Bob and then sending a `commitment_signed` message with the appropriate signatures.

<p align="center" style="width: 50%; max-width: 300px;">
  <img src="./tutorial_images/alice_bob_tcp_1.png" alt="alice_bob_tcp_1" width="70%" height="auto">
</p>

Notice that the `commitment_signed` does not explitly mention which HTLCs the signatures are for. Instead, it does this implicitly. Since Lightning messages are assumed to be ordered and reliable, the protocol assumes that messages sent will always arrive, and they will arrive in the order they are sent. This way, Alice can rest assured that, if Bob gets the `commitment_signed`, he also got the `update_add_htlc` messages in the correct order.

</details>

An in-depth review of the Transmission Control Protocol is outside of the scope of this course. However, for the curious reader, we'll note that TCP achieves reliable message delivery by assigning a *sequence number* to each byte of data transmitted to the receiver. To ensure that the data was successfully received, TCP requires the reciever to send a positive acknowledgment (ACK) back to the sender. If the ACK message is not received before the time-out interval, the data will be sent again.

Additionally, since the data is transmitted with sequence numbers, the receiver can correctly order the data they recieve, ensuring that it is processed and handled in the right order. Cool stuff, eh!