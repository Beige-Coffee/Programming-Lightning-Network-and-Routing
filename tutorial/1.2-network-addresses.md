# Lightning Network Communication Protocol

So, we've determined that Alice and Bob will communicate with each other using one of the various TCP/IP protocols: IPv4, IPv6, or Tor.

Below is a diagram depicting how they may identify each other if they were using IPv4. For instance, imagine that Alice knows that Bob's Lightning node can be found at the IP Address: **198.51.100.89**.

#### Question: Which port is Bob's Lightning node _most likely_ running on? Why?

> HINT: If you don't know the answer, you can find it in [BOLT #1](https://github.com/lightning/bolts/blob/master/01-messaging.md)!

<details>
  <summary>Answer</summary>

Bob's Lightning node is probably running on port **9735**!

Why is that? According to [BOLT #1: Base Protocol](https://github.com/lightning/bolts/blob/master/01-messaging.md), 9375 is teh default TCP port for mainnet Lightning nodes. The other default ports are listed below:
- **Testnet**: 19735
- **Signet**: 39735

By specifying a default port, it reduces friction for both Lightning users, developers, and educators, as everyone can create shared software and documenation that assumes a port number. That said, your Lightning node is free to run on a different port - it does not have to be 9375.

</details>

<p align="center" style="width: 50%; max-width: 300px;">
  <img src="./tutorial_images/alice_bob_address.png" alt="alice_bob_address" width="100%" height="auto">
</p>

## Establishing Identity

Great, so Alice knows *where* she can find bob in cyberspace - at his internet address: **198.51.100.89:9735**!

#### Question: Imagine Alice connects to 198.51.100.89:9735 and starts sending messages. Can she be sure she is actually communicating with Bob?

<details>
  <summary>Answer</summary>

No! If Alice simply connect to Bob's IP address, she has no guarentee that it's actually Bob. For instance, IP Addresses can change - perhaps Bob's Internet Service Provide (ISP) assigns him a new IP address. Or, worse, an attacker is intercepting the traffic heading to Bob's IP address and pretends to be Bob.

What we really want is a **cryptographic** assurance that we're actually communicating with Bob. And, similarly, Bob will want a cryptographic guarentee that we're (Alice) actually the ones communicating with him.

**To achieve this, each node on the Lightning network will have it's own public key, which serves as its identity.**

</details>

### Public Key = Identity
In the Lightning Network, your node's public key is your *long-term* identity. As we'll see shortly, this public key allows users to cryptographically attest to messages they send, and it provides their peers with a useful tool they can use to encrypt data so that it remains private in transit.

At this point, a valid concern one may have is how the Lightning Network protects against sybil attacks whereby an attacker creates hundreds, thousands, or more nodes and floods the Lightning Network with messages. One (bad!) solution would be to have a central authority issue public keys, and you simply check if the incoming connection is from a trusted public key, but that is an obvious no-no.

A better, more clever solution exists! Imagine Alice has a channel open with Bob. Bob has two *connections* - one with **Purple Node** and one with **Green Node**. Keep in mind Bob does not have a channel open - he simply has a TCP/IP connection to their Lightning nodes. The crucial difference between **Purple Node** and **Green Node** is that **Purple Node** has a public channel open with another node on the Lightning Network. On the other hand, **Green Node** either has only private channels or no channel at all.

<p align="center" style="width: 50%; max-width: 300px;">
  <img src="./tutorial_images/sybil_mitigation.png" alt="sybil_mitigation" width="100%" height="auto">
</p>



#### Question: Imagine Bob attempts to relay gossip messages from both Purple Node and Green Node to Alice. Which messages will she accept and why?

> HINT: Part of the answer has to do with the [`channel_announcement`](https://github.com/lightning/bolts/blob/master/07-routing-gossip.md#the-channel_announcement-message) message!

<details>
  <summary>Answer</summary>

To mitigate against sybil attacks in a decentralized system where anyone is free to join, the Lightning Network **suggests** that nodes ignore gossip messages from Public Keys that **do not** have a public channel open on the Lightning Network. This has the result of imposing a real-world monetary cost to sending messages (which others will accept) on the Lightning Network, since, to open a public Lightning channel, you must spend bitcoin and allocate funds on-chain.

To prove to the wider network that you have publically opened a channel, you will broadcast a `channel_announcement` message when opening a channel. This message will include the both public keys that are present in the 2-of-2 multisig funding transaction and signatures that sign the content of the `channel_announcement` message itself. Crucially, these signatures will be produced by **both** the private keys associated with the public keys *in the funding output* and the Lightning node's public key - proving to the entire network that both parties truly locked funds in an on-chain output and that they attest `channel_announcement` message itself. The spam prevention rule applies specifically to **gossip relay** (building the network graph), not to direct peer-to-peer interactions.

<p align="center" style="width: 50%; max-width: 300px;">
  <img src="./tutorial_images/channel_announcement.png" alt="channel_announcement" width="100%" height="auto">
</p>

</details>


### Generating A Public Key

Various Lightning implementations (LND, LDK, Eclair, C-Lightning, etc.) implement key derivation differently. Below is an example that is, roughly, based on how LND derives keys for each Lightning node.

> NOTE: The full explanation of Lightning channel keys is outside the scope of this workshop. If you'd like to learn about that, please visit the first module: Intro to Payment Channels.

With that said, it's worth briefly discussing how one could build a Lightning wallet such that their node's public and private key could be derived from a single seed - along with all of the other keys that are needed to operate a Lightning channel.

### HD Wallets

BIP 32  describes a **hierarchical deterministic** (**HD**) wallet structure and introduces the following characteristics for key management:
- **Single Source**: All public and private keys can be derived from a single seed. As long as you have access to the seed, you can re-derive the entire wallet.
- **Hierarchical**: All keys are organized into a tree structure.
- **Deterministic**: Each time you restore you wallet from your seed, you'll get the exact same result.

### Derivation Paths
A few important BIPs, such as [BIP 43](https://bips.dev/43/) and [BIP 44](https://bips.dev/44/), build on BIP 32 and describe the following derivation scheme that can be used to organize keys.
```
m / purpose' / coin_type' / account' / change / address_index
```

We can leverage the above scheme to build an HD wallet that can provide us with all of the keys we'll need to operate a Lightning node.

<p align="center" style="width: 50%; max-width: 300px;">
  <img src="./tutorial_images/node_key_derivation.png" alt="node_key_derivation" width="100%" height="auto">
</p>

Here is how to interpret the above scheme:
- `m`: This is the master extended key for the wallet, derived from our wallet's seed.
- `purpose'`: We'll use `1017'` for the purpose. This is the value that LND uses. Since our key derivation scheme is LND-inspired, we'll use it too! That said, it's an arbitrary choice and not specified in any Bitcoin or Lightning protocol specification. We're simply using it as a unique value to plug into the derivation scheme.
- `coin_type'`: Since we're ultimately testing our Lightning implementation against the BOLT Test Vectors, we'll use `0` for this course. Remember, `0` is mainnet bitcoin.
- `account'`: This is where the magic happens. We'll specify a specific **key family** for each `account`. This will enable us to deterministically derive unique public and private keys for each channel our Lightning node opens.
- `receiving`: We won't be generating any change addresses with this field, so we'll keep `0` (receiving) as a default value here.
- `index`: The index will be unique for each channel we open.

#### The key takeaway here, is that we can derive a node Public/Private key for our node by using the key derived at the following index:
```
m / 1017' / 0' / 6' / 0 / 0
```

## Communicating Public Keys
To provide a stronger assurance that Alice and Bob are truly communicating with each other, they will both publicize their Lightning node's **public key**. This is a special public key, as it is used to sign protocol messages and authenticate connections.

Let's return to the example above where Alice wants to initiate a connection with Bob. How would she know Bob's public key? Well, there are a few different ways.

#### Network Gossip
One way is for Alice to recieve Bob's `node_announcement` gossip message. We'll review [BOLT #7: Routing Gossip](https://github.com/lightning/bolts/blob/master/07-routing-gossip.md#the-node_announcement-message) in more detail later in this course, but the spoiler alert is that Lightning's Gossip Protocol defines how Lightning nodes should communicate important information to each other. In this case, Bob wants to communicate information about his Lightning channel to others on the network, so he sends the following pieces of information:
- **signature**: Bob will use his Lightning node private key to sign the content of the `node_announcement` message, proving a digital attestation to the message contents.
- **features**: We'll discuss this field in more detail later, but this is where Bob will signal which features his node supports.
- **node_id**: This is Bob's public key!
- **rbg_clor**: This field allows Bob to specify which color Bob wants his node to be for any interfaces that support this feature.
- **alias**: This is a human-readable name for Bob's node. Fun fact: Some Lightning implementations will actually ignore this because it can become an attack vector if a node wants to put malicious text that will execute harmful code if processed.
- **addresses**: Finally, this is where Bob specifies any addresses (IPv4, IPv6, Tor v3, DNS) where he can be reached.

<p align="center" style="width: 50%; max-width: 300px;">
  <img src="./tutorial_images/node_announcement.png" alt="node_announcement" width="100%" height="auto">
</p>

#### Out-of-band
Of course, another option is simply that Alice and Bob exchange their public keys and addresses out-of-band. If you've ever set up a Lightning channel with a friend, this is probably the route you took!

<p align="center" style="width: 50%; max-width: 300px;">
  <img src="./tutorial_images/text_messages.png" alt="text_messages" width="70%" height="auto">
</p>